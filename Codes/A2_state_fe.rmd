In the main regresion analysis in the manuscript, state FEs are included. County FEs are not included as it eliminates too much of the variation in aquifer thickness. This appendix compares the impact of aquifer thickness on irrigated share with and without State FEs.

# Regression with and without state fixed effects

## Without State FEs

### Corn

```{r}
data_corn <- readRDS(here("Shared/Data/ProcessedData/data_corn.rds"))

#--- define the semi-parametric portion of the model ---#
semi_formula <-
  formula(yield ~ s(balance, by = sat_cat, k = 3, m = 2))

#--- semi-parametric FE wih fixest ---#
semi_res <-
  semi_ols(
    semi_formula = semi_formula,
    c_formula = "i(sat_cat, ref = 'dryland') + i(year) + i(sc_dry)",
    # fe = "",
    cluster = "sc_dry",
    data = data_corn
  )

#--- main regression results ---#
y_res_int <- semi_res$fe_res

r2_corn_wb <- r2(y_res_int, type = "r2")

gam_y_res <- semi_res$gam_res

#--- raw data for prediction ---#
data_for_pred_corn <-
  CJ(
    balance = seq(min(data_corn$balance), max(data_corn$balance), length = 50),
    sat_cat = unique(data_corn$sat_cat)
  ) %>%
  .[, sat := case_when(
    sat_cat == "[39.4,82]" ~ 40,
    sat_cat == "(82,194]" ~ 194,
    sat_cat == "(194,708]" ~ 348,
    sat_cat == "dryland" ~ 0
  )] %>%
  .[is.na(sat), sat := 0] %>%
  # === can be any sc_code (need to shift yield for "average" county) ===#
  # .[, sc_code := data_corn$sc_code[2]] %>%
  .[, sc_code := data_corn[sat_cat != "dryland"]$sc_code[1]] %>%
  .[, sc_dry := paste0(data_corn$sc_dry[1])] %>%
  # === can be any year (need to shift yield for "average" year) ===#
  .[, year := 2009] %>%
  # === fake yield data (necessary to take advantage of predict.gam) ===#
  .[, yield := 0] %>%
  .[, type := "pred"] %>%
  .[, dry_or_not := fifelse(sat_cat == "dryland", 1, 0) %>% factor()]

#--- create bases  ---#
yhat_data_corn <-
  gen_smooth_data(
    data = data_for_pred_corn,
    gam_res = gam_y_res
  ) %>%
  .$data

y_hat_with_se <- predict(y_res_int, newdata = yhat_data_corn, se.fit = TRUE)

yhat_data_corn[, `:=`(
  y_hat = y_hat_with_se$fit,
  y_hat_se = y_hat_with_se$se.fit
)]

yhat_data_corn[, sat_cat_q :=
  as.numeric(sat_cat) %>%
  ordinal() %>%
  paste0(., " quintile")]

ir_share_data_corn <-
  data_corn %>%
  .[ir == "ir" & ir_area_ratio >= 0.75, ] %>%
  .[, balance_avg := mean(balance), by = sc_code] %>%
  .[, type := "Corn"]

ir_share_res_corn <-
  gam(
    acres_ratio ~
      s(sat, k = 3, m = 2) + s(balance_avg, k = 3, m = 2) +
      ti(sat, balance_avg, k = 3) + factor(year),
    data = ir_share_data_corn,
    # weight = ~acres,
    family = binomial
  )

share_pred_data_corn <-
  CJ(
    sat = seq(
      min(ir_share_data_corn$sat),
      max(ir_share_data_corn$sat),
      length = 100
    ),
    balance_avg = mean(ir_share_data_corn$balance_avg),
    year = 2016
  )

ir_share_hat_data <-
  predict(
    ir_share_res_corn,
    newdata = share_pred_data_corn,
    type = "response",
    se.fit = TRUE
  )

share_pred_data_corn[, ir_share_hat := ir_share_hat_data$fit]
share_pred_data_corn[, ir_share_hat_se := ir_share_hat_data$se.fit]
```

### Soybean

```{r}
data_soy <- readRDS(here("Shared/Data/ProcessedData/data_soy.rds"))

#--- define the semi-parametric portion of the model ---#
semi_formula <- formula(yield ~ s(balance, by = sat_cat, k = 3, m = 2))

#--- semi-parametric FE wih fixest ---#
semi_res <-
  semi_ols(
    semi_formula = semi_formula,
    c_formula = "i(sat_cat, ref = 'dryland') + i(year) + i(sc_dry)",
    # fe = "",
    cluster = "sc_dry",
    data = data_soy
  )

#--- main regression results ---#
y_res_int <- semi_res$fe_res

r2_soy_wb <- r2(y_res_int, type = "r2")

gam_y_res <- semi_res$gam_res

#--- raw data for prediction ---#
data_for_pred_soy <-
  CJ(
    balance = seq(min(data_soy$balance), max(data_soy$balance), length = 50),
    sat_cat = unique(data_soy$sat_cat)
  ) %>%
  .[, sat := case_when(
    sat_cat == "[39.4,82]" ~ 40,
    sat_cat == "(82,194]" ~ 194,
    sat_cat == "(194,708]" ~ 348,
    sat_cat == "dryland" ~ 0
  )] %>%
  .[is.na(sat), sat := 0] %>%
  # === can be any sc_code (need to shift yield for "average" county) ===#
  .[, sc_code := data_soy$sc_code[1]] %>%
  .[, sc_dry := data_soy$sc_dry[1]] %>%
  # === can be any year (need to shift yield for "average" year) ===#
  .[, year := 2009] %>%
  # === fake yield data (necessary to take advantage of predict.gam) ===#
  .[, yield := 0] %>%
  .[, type := "pred"] %>%
  .[, dry_or_not := fifelse(sat_cat == "dryland", 1, 0) %>% factor()]

#--- create bases  ---#
yhat_data_soy <-
  gen_smooth_data(
    data = data_for_pred_soy,
    gam_res = gam_y_res
  ) %>%
  .$data

y_hat_with_se <- predict(y_res_int, newdata = yhat_data_soy, se.fit = TRUE)

yhat_data_soy[, `:=`(
  y_hat = y_hat_with_se$fit,
  y_hat_se = y_hat_with_se$se.fit
)]

yhat_data_soy[, sat_cat_q :=
  as.numeric(sat_cat) %>%
  ordinal() %>%
  paste0(., " quintile")]


ir_share_data_soy <-
  data_soy %>%
  .[ir == "ir" & ir_area_ratio >= 0.75, ] %>%
  .[, balance_avg := mean(balance), by = sc_code] %>%
  .[, type := "Soybean"]

ir_share_res_soy <-
  gam(
    acres_ratio ~
      s(sat, k = 4, m = 2) +
      s(balance_avg, k = 3, m = 2) +
      ti(sat, balance_avg, k = 3, m = 2) +
      factor(state_name) +
      factor(year),
    data = ir_share_data_soy,
    # weight = ~acres,
    family = binomial
  )

share_pred_data_soy <-
  CJ(
    sat = seq(
      min(ir_share_data_soy$sat),
      max(ir_share_data_soy$sat),
      length = 100
    ),
    balance_avg = mean(ir_share_data_soy$balance_avg),
    year = 2016,
    state_name = "Nebraska"
  )

ir_share_hat_data <-
  predict(
    ir_share_res_soy,
    newdata = share_pred_data_soy,
    type = "response",
    se.fit = TRUE
  )

share_pred_data_soy[, ir_share_hat := ir_share_hat_data$fit]
share_pred_data_soy[, ir_share_hat_se := ir_share_hat_data$se.fit]
```

```{r}
plot_data_ir_share_no_sfe <-
  rbind(
    share_pred_data_corn[, .(ir_share_hat, ir_share_hat_se, sat)][, type := "Corn"],
    share_pred_data_soy[, .(ir_share_hat, ir_share_hat_se, sat)][, type := "Soybean"]
  ) %>%
  .[, sfe := "No State FE"]
```

## With State FEs (Main)

### Corn

```{r}
ir_share_res_corn <-
  gam(
    acres_ratio ~
      s(sat, k = 3, m = 2) +
      s(balance_avg, k = 3, m = 2) +
      ti(sat, balance_avg, k = 3) +
      factor(state_name) +
      factor(year),
    data = ir_share_data_corn,
    # weight = ~acres,
    family = binomial
  )

share_pred_data_corn <-
  CJ(
    sat = seq(
      min(ir_share_data_corn$sat),
      max(ir_share_data_corn$sat),
      length = 100
    ),
    balance_avg = mean(ir_share_data_corn$balance_avg),
    year = 2016,
    state_name = "Nebraska"
  )

ir_share_hat_data <-
  predict(
    ir_share_res_corn,
    newdata = share_pred_data_corn,
    type = "response",
    se.fit = TRUE
  )

share_pred_data_corn[, ir_share_hat := ir_share_hat_data$fit]
share_pred_data_corn[, ir_share_hat_se := ir_share_hat_data$se.fit]
```

### Soybean

```{r}
ir_share_res_soy <-
  gam(
    acres_ratio ~
      s(sat, k = 4, m = 2) +
      s(balance_avg, k = 3, m = 2) +
      ti(sat, balance_avg, k = 3, m = 2) +
      factor(state_name) +
      factor(year),
    data = ir_share_data_soy,
    # weight = ~acres,
    family = binomial
  )

share_pred_data_soy <-
  CJ(
    sat = seq(
      min(ir_share_data_soy$sat),
      max(ir_share_data_soy$sat),
      length = 100
    ),
    balance_avg = mean(ir_share_data_soy$balance_avg),
    year = 2016,
    state_name = "Nebraska"
  )

ir_share_hat_data <-
  predict(
    ir_share_res_soy,
    newdata = share_pred_data_soy,
    type = "response",
    se.fit = TRUE
  )

share_pred_data_soy[, ir_share_hat := ir_share_hat_data$fit]
share_pred_data_soy[, ir_share_hat_se := ir_share_hat_data$se.fit]
```

```{r}
plot_data_ir_share_with_sfe <-
  rbind(
    share_pred_data_corn[, .(ir_share_hat, ir_share_hat_se, sat)][, type := "Corn"],
    share_pred_data_soy[, .(ir_share_hat, ir_share_hat_se, sat)][, type := "Soybean"]
  ) %>%
  .[, sfe := "With State FE"]
```

```{r}
plot_data_ir_share <-
  rbind(
    plot_data_ir_share_with_sfe,
    plot_data_ir_share_no_sfe
  )

g_share_comp <-
  ggplot(plot_data_ir_share[sat <= 500, ]) +
  geom_line(aes(y = ir_share_hat, x = sat * 0.3048)) +
  geom_ribbon(
    aes(
      ymin = ir_share_hat - 1.96 * ir_share_hat_se,
      ymax = ir_share_hat + 1.96 * ir_share_hat_se,
      x = sat * 0.3048
    ),
    alpha = 0.4
  ) +
  ylim(0.25, 1) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.1)) +
  scale_x_continuous(breaks = seq(10, 160, by = 20)) +
  xlab("Saturated Thickness (meter)") +
  ylab("Share of Irrigated Acres") +
  facet_grid(type ~ sfe) +
  theme_fig +
  theme(
    strip.text = element_text(face = "bold"),
    strip.background = element_blank()
  )

ggsave(
  file = "GitControlled/Writing/Figures/g_share_comp.pdf",
  g_share_comp,
  height = 5,
  width = 6
)
```

# Loss of variation in aquifer thickness 

```{r}
ir_share_data_corn[, sat_m := measurements::conv_unit(sat, "ft", "m")]

s_deam_data <-
  ir_share_data_corn[, .(sat_m = sat_m - mean(sat_m)), by = state_name] %>%
  .[, type := "B. Demeaned by State Average"] %>%
  .[, .(sat_m, type)]

c_deam_data <-
  ir_share_data_corn[, .(sat_m = sat_m - mean(sat_m)), by = sc_code] %>%
  .[, type := "C. Demeaned by County Average"] %>%
  .[, .(sat_m, type)]

non_deam_data <-
  ir_share_data_corn[, .(sat_m = sat_m - mean(sat_m))] %>%
  .[, type := "A. Demeaned by Overall Average"]

plot_data <- rbind(s_deam_data, c_deam_data, non_deam_data)

g_variation <-
  ggplot(plot_data) +
  geom_histogram(aes(x = sat_m)) +
  facet_wrap(type ~ ., ncol = 1) +
  theme_fig +
  theme(
    strip.background = element_blank(),
    strip.text = element_text(hjust = 0, face = "bold")
  ) +
  xlab("Aquifer Thickness") +
  ylab("Count")

ggsave(
  file = "GitControlled/Writing/Figures/g_variation.pdf",
  g_variation,
  height = 5,
  width = 6
)
```