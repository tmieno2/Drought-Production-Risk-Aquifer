In the main regresion analysis in the manuscript, state FEs are included. County FEs are not included as it eliminates too much of the variation in aquifer thickness. This appendix compares the impact of aquifer thickness on irrigated share with and without State FEs.

# Regression with and without state fixed effects

```{r}
reg_results_data <- readRDS(here::here("Shared/Results/reg_results_data.rds"))
```

## Without State FEs

### Corn

```{r}
ir_share_data_corn <- reg_results_data[crop == "Corn", share_data][[1]]

ir_share_res_corn <-
  gam(
    acres_ratio ~
      s(sat, k = 3, m = 2) + s(balance_avg, k = 3, m = 2) +
      ti(sat, balance_avg, k = 3) + factor(year),
    data = ir_share_data_corn,
    # weight = ~acres,
    family = binomial
  )

share_pred_data_corn <-
  CJ(
    sat = seq(
      min(ir_share_data_corn$sat),
      max(ir_share_data_corn$sat),
      length = 100
    ),
    balance_avg = mean(ir_share_data_corn$balance_avg),
    year = 2016
  )

ir_share_hat_data <-
  predict(
    ir_share_res_corn,
    newdata = share_pred_data_corn,
    type = "response",
    se.fit = TRUE
  )

share_pred_data_corn[, ir_share_hat := ir_share_hat_data$fit]
share_pred_data_corn[, ir_share_hat_se := ir_share_hat_data$se.fit]
```

### Soybean

```{r}
ir_share_data_soy <- reg_results_data[crop == "Soybean", share_data][[1]]

ir_share_res_soy <-
  gam(
    acres_ratio ~
      s(sat, k = 4, m = 2) +
      s(balance_avg, k = 3, m = 2) +
      ti(sat, balance_avg, k = 3, m = 2) +
      factor(state_name) +
      factor(year),
    data = ir_share_data_soy,
    # weight = ~acres,
    family = binomial
  )

share_pred_data_soy <-
  CJ(
    sat = seq(
      min(ir_share_data_soy$sat),
      max(ir_share_data_soy$sat),
      length = 100
    ),
    balance_avg = mean(ir_share_data_soy$balance_avg),
    year = 2016,
    state_name = "Nebraska"
  )

ir_share_hat_data <-
  predict(
    ir_share_res_soy,
    newdata = share_pred_data_soy,
    type = "response",
    se.fit = TRUE
  )

share_pred_data_soy[, ir_share_hat := ir_share_hat_data$fit]
share_pred_data_soy[, ir_share_hat_se := ir_share_hat_data$se.fit]
```

```{r}
plot_data_ir_share_no_sfe <-
  rbind(
    share_pred_data_corn[, .(ir_share_hat, ir_share_hat_se, sat)][, type := "Corn"],
    share_pred_data_soy[, .(ir_share_hat, ir_share_hat_se, sat)][, type := "Soybean"]
  ) %>%
  .[, sfe := "No State FE"]
```

## With State FEs (Main)

### Corn

```{r}
ir_share_res_corn <-
  gam(
    acres_ratio ~
      s(sat, k = 3, m = 2) +
      s(balance_avg, k = 3, m = 2) +
      ti(sat, balance_avg, k = 3) +
      factor(state_name) +
      factor(year),
    data = ir_share_data_corn,
    # weight = ~acres,
    family = binomial
  )

share_pred_data_corn <-
  CJ(
    sat = seq(
      min(ir_share_data_corn$sat),
      max(ir_share_data_corn$sat),
      length = 100
    ),
    balance_avg = mean(ir_share_data_corn$balance_avg),
    year = 2016,
    state_name = "Nebraska"
  )

ir_share_hat_data <-
  predict(
    ir_share_res_corn,
    newdata = share_pred_data_corn,
    type = "response",
    se.fit = TRUE
  )

share_pred_data_corn[, ir_share_hat := ir_share_hat_data$fit]
share_pred_data_corn[, ir_share_hat_se := ir_share_hat_data$se.fit]
```

### Soybean

```{r}
ir_share_res_soy <-
  gam(
    acres_ratio ~
      s(sat, k = 4, m = 2) +
      s(balance_avg, k = 3, m = 2) +
      ti(sat, balance_avg, k = 3, m = 2) +
      factor(state_name) +
      factor(year),
    data = ir_share_data_soy,
    # weight = ~acres,
    family = binomial
  )

share_pred_data_soy <-
  CJ(
    sat = seq(
      min(ir_share_data_soy$sat),
      max(ir_share_data_soy$sat),
      length = 100
    ),
    balance_avg = mean(ir_share_data_soy$balance_avg),
    year = 2016,
    state_name = "Nebraska"
  )

ir_share_hat_data <-
  predict(
    ir_share_res_soy,
    newdata = share_pred_data_soy,
    type = "response",
    se.fit = TRUE
  )

share_pred_data_soy[, ir_share_hat := ir_share_hat_data$fit]
share_pred_data_soy[, ir_share_hat_se := ir_share_hat_data$se.fit]
```

```{r}
plot_data_ir_share_with_sfe <-
  rbind(
    share_pred_data_corn[, .(ir_share_hat, ir_share_hat_se, sat)][, type := "Corn"],
    share_pred_data_soy[, .(ir_share_hat, ir_share_hat_se, sat)][, type := "Soybean"]
  ) %>%
  .[, sfe := "With State FE"]
```


## With State-year FEs (Main)

### Corn

```{r}
ir_share_data_corn[, state_year := paste0(state_name, year)]

ir_share_res_corn <-
  gam(
    acres_ratio ~
      s(sat, k = 3, m = 2) +
      s(balance_avg, k = 3, m = 2) +
      ti(sat, balance_avg, k = 3) +
      factor(state_year),
    data = ir_share_data_corn,
    # weight = ~acres,
    family = binomial
  )

share_pred_data_corn <-
  CJ(
    sat = seq(
      min(ir_share_data_corn$sat),
      max(ir_share_data_corn$sat),
      length = 100
    ),
    balance_avg = mean(ir_share_data_corn$balance_avg),
    year = 2016,
    state_year = "Nebraska2009"
  )

ir_share_hat_data <-
  predict(
    ir_share_res_corn,
    newdata = share_pred_data_corn,
    type = "response",
    se.fit = TRUE
  )

share_pred_data_corn[, ir_share_hat := ir_share_hat_data$fit]
share_pred_data_corn[, ir_share_hat_se := ir_share_hat_data$se.fit]
```

### Soybean

```{r}
ir_share_data_soy[, state_year := paste0(state_name, year)]

ir_share_res_soy <-
  gam(
    acres_ratio ~
      s(sat, k = 4, m = 2) +
      s(balance_avg, k = 3, m = 2) +
      ti(sat, balance_avg, k = 3, m = 2) +
      factor(state_year),
    data = ir_share_data_soy,
    # weight = ~acres,
    family = binomial
  )

share_pred_data_soy <-
  CJ(
    sat = seq(
      min(ir_share_data_soy$sat),
      max(ir_share_data_soy$sat),
      length = 100
    ),
    balance_avg = mean(ir_share_data_soy$balance_avg),
    year = 2016,
    state_year = "Nebraska2009"
  )

ir_share_hat_data <-
  predict(
    ir_share_res_soy,
    newdata = share_pred_data_soy,
    type = "response",
    se.fit = TRUE
  )

share_pred_data_soy[, ir_share_hat := ir_share_hat_data$fit]
share_pred_data_soy[, ir_share_hat_se := ir_share_hat_data$se.fit]
```

```{r}
plot_data_ir_share_with_syfe <-
  rbind(
    share_pred_data_corn[, .(ir_share_hat, ir_share_hat_se, sat)][, type := "Corn"],
    share_pred_data_soy[, .(ir_share_hat, ir_share_hat_se, sat)][, type := "Soybean"]
  ) %>%
  .[, sfe := "With State-year FE"]
```

```{r}
plot_data_ir_share <-
  rbind(
    plot_data_ir_share_with_sfe,
    plot_data_ir_share_with_syfe,
    plot_data_ir_share_no_sfe
  )

g_share_comp <-
  ggplot(plot_data_ir_share[sat <= 500, ]) +
  geom_line(aes(y = ir_share_hat, x = sat * 0.3048)) +
  geom_ribbon(
    aes(
      ymin = ir_share_hat - 1.96 * ir_share_hat_se,
      ymax = ir_share_hat + 1.96 * ir_share_hat_se,
      x = sat * 0.3048
    ),
    alpha = 0.4
  ) +
  ylim(0.25, 1) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.1)) +
  scale_x_continuous(breaks = seq(10, 160, by = 20)) +
  xlab("Saturated Thickness (meter)") +
  ylab("Share of Irrigated Acres") +
  facet_grid(type ~ sfe) +
  # theme_fig +
  theme(
    strip.text = element_text(face = "bold"),
    strip.background = element_blank()
  )

ggsave(
  file = "GitControlled/Writing/Figures/g_share_comp.pdf",
  g_share_comp,
  height = 5,
  width = 6
)
```

# Loss of variation in aquifer thickness 

```{r}
ir_share_data_corn[, sat_m := measurements::conv_unit(sat, "ft", "m")]

sy_demeaan_data <-
  copy(ir_share_data_corn)[, .(sat_m = sat_m - mean(sat_m)), by = .(state_name, year)] %>%
  .[, type := "B. Demeaned by State-Year Average"] %>%
  .[, .(sat_m, type)]

c_y_demeaan_data <-
  copy(ir_share_data_corn)[, sat_m := sat_m - mean(sat_m), by = sc_code] %>%
  .[, .(sat_m = sat_m - mean(sat_m)), by = year] %>%
  .[, type := "C. Demeaned by County and Yearly Average"] %>%
  .[, .(sat_m, type)]

y_demeaan_data <-
  copy(ir_share_data_corn)[, .(sat_m = sat_m - mean(sat_m)), by = year] %>%
  .[, type := "A. Demeaned by Yearly Average"] %>%
  .[, .(sat_m, type)]

plot_data <- rbind(sy_demeaan_data, c_y_demeaan_data, y_demeaan_data)

g_variation <-
  ggplot(plot_data) +
  geom_histogram(aes(x = sat_m)) +
  facet_wrap(type ~ ., ncol = 1) +
  theme_fig +
  theme(
    strip.background = element_blank(),
    strip.text = element_text(hjust = 0, face = "bold")
  ) +
  xlab("Aquifer Thickness") +
  ylab("Count")

ggsave(
  file = "GitControlled/Writing/Figures/g_variation.pdf",
  g_variation,
  height = 5,
  width = 6
)
```
