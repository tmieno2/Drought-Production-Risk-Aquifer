```{r}
final_data <-
  here("Shared/Data/ProcessedData/final_data.rds") %>%
  # here::here("../Shared/Data/ProcessedData/final_data.rds") %>%
  readRDS()


#--- Data used for regression analysis ---#
reg_data <-
  prepare_reg_data(
    data = final_data,
    #--- saturated thickness has to be at least 9 meters ---#
    sat_thld_m = 9,
    #--- at least 75% of total county area has to be overlapped with HPA ---#
    ir_share_thld = 0.75,
    #--- drop obs with extreme balance ---#
    balance_thld = c(-1200, 200),
    #--- number of saturated thickness categories ---#
    sat_cat_num = 3,
    #--- select states of focus ---#
    # no observations are dropped with the current set of states
    state_ls =
      list(
        corn = c("CO", "KS", "NE", "NM", "SD", "TX", "WY"),
        soy = c("KS", "NE", "TX")
      )
  ) %>%
  data.table() %>%
  setnames("crop_type", "crop")
```


```{r}
sc_list <-
  reg_data$data[[1]] %>%
  .[, comp := sum(ir == "nir" | ir == "ir"), by = .(sc_code, year)] %>%
  .[comp %in% c(1, 2), ] %>%
  .[sat_cat != "dryland", .(sc_code, geometry, comp)] %>%
  unique(by = "sc_code") %>%
  st_as_sf()

reg_data$data[[1]] %>%
  .[, comp := sum(ir == "nir" | ir == "ir"), by = .(sc_code, year)] %>%
  .[comp == 1, ] %>%
  .[sat_cat != "dryland", ] %>%
  .[, .N, by = sc_code]

ggplot(data = sc_list) +
  geom_sf(aes(fill = factor(comp)))

reg_data$data[[1]] %>%
  .[, comp := sum(ir == "nir" | ir == "ir"), by = .(sc_code, year)] %>%
  .[comp == 2, ] %>%
  .[sat_cat != "dryland", ] %>%
  .[, unique(sc_code)]
```

